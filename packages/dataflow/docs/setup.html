<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Setup - Dataflow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="setup.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/styles/intellij-light.min.css">
    <script type="importmap">
        {
            "imports": {
                "highlight.js/": "https://esm.run/highlight.js/"
            }
        }
    </script>
</head>
<body>

<div class="site-header">
    <h1>Dataflow</h1>
    <a href="https://github.com/bodar/bodar.ts/tree/master/packages/dataflow"><img alt="GitHub" src="https://img.shields.io/badge/github-repo-blue?logo=github"></a>
</div>

<nav class="docs-nav">
    <a href="index.html">Quick Start</a>
    <a href="setup.html" class="active">Setup</a>
    <a href="reactivity.html">Reactivity</a>
    <a href="inputs.html">Inputs</a>
    <a href="islands.html">Islands</a>
    <a href="examples/">Examples</a>
</nav>

<h1>Setup</h1>

<p>Dataflow transforms HTML containing <code>is="reactive"</code> scripts into interactive pages. Configure your setup by selecting your runtime, module strategy, and transformation location.</p>

<!-- Import runtime APIs -->
<script type="module" is="reactive">
    import {display, view, mutable} from '@bodar/dataflow/runtime.ts';
</script>

<!-- Step 1: Runtime Selection -->
<section class="setup-section">
    <h2>1. Runtime Environment</h2>
    <p>Where will you run the transformation?</p>

    <script type="module" is="reactive">
        const runtime = mutable('node');

        const runtimes = [
            {id: 'node', name: 'Node.js', logo: 'nodedotjs'},
            {id: 'bun', name: 'Bun', logo: 'bun'},
            {id: 'deno', name: 'Deno', logo: 'deno'},
            {id: 'browser', name: 'Browser', logo: 'googlechrome'}
        ];

        display(<div class="selector-grid">
            {runtimes.map(rt =>
                <label class="selector-card">
                    <input type="radio" name="runtime" value={rt.id}
                           onchange={() => runtime.value = rt.id}/>
                    <div class="card-content">
                        <img src={`https://cdn.simpleicons.org/${rt.logo}`} alt={rt.name} class="runtime-logo"/>
                        <span class="card-label">{rt.name}</span>
                    </div>
                </label>
            )}
        </div>);
    </script>
</section>

<!-- Step 2: Module Strategy Selection -->
<section class="setup-section">
    <h2>2. Module Strategy</h2>
    <p>How should imports be resolved?</p>

    <script type="module" is="reactive">
        const strategy = mutable('importmap');

        const strategies = [
            {id: 'bundler', name: 'Bundler', desc: 'Bundle and minify reactive imports with BunBundler', requiresBun: true},
            {id: 'importmap', name: 'Import Map', desc: 'Use pre-minified runtime via import map (~11KB gzipped)'},
            {id: 'byo', name: 'Bring Your Own', desc: 'You manage your own import map or bundling'}
        ];

        display(<div class="selector-list">
            {strategies.map(s => {
                const disabled = s.requiresBun && runtime !== 'bun';
                return <label class={`selector-option ${disabled ? 'disabled' : ''}`}>
                    <input type="radio" name="strategy" value={s.id}
                           disabled={disabled}
                           onchange={() => strategy.value = s.id}/>
                    <div class="option-content">
                        <strong>{s.name}</strong>
                        <span class="option-desc">{s.desc}</span>
                        {disabled ? <span class="option-requires">Requires Bun runtime</span> : ''}
                    </div>
                </label>;
            })}
        </div>);
    </script>
</section>

<!-- Step 3: Transformation Location -->
<section class="setup-section">
    <h2>3. Transformation Location</h2>
    <p>When should HTML be transformed?</p>

    <script type="module" is="reactive">
        const location = mutable('build');

        const locations = [
            {id: 'build', name: 'Build Time', desc: 'Static site generation or build pipelines'},
            {id: 'server', name: 'Server', desc: 'Transform on each request (Bun.serve, Node, etc.)'},
            {id: 'edge', name: 'Edge', desc: 'Cloudflare Workers or other edge runtimes', disabledWhen: () => strategy === 'bundler', requiresMsg: 'Requires Import Map or BYO'},
            {id: 'browser', name: 'Browser', desc: 'Service Worker for progressive enhancement', disabledWhen: () => runtime !== 'browser', requiresMsg: 'Requires Browser runtime'}
        ];

        display(<div class="selector-list">
            {locations.map(loc => {
                const disabled = loc.disabledWhen?.() ?? false;
                return <label class={`selector-option ${disabled ? 'disabled' : ''}`}>
                    <input type="radio" name="location" value={loc.id}
                           disabled={disabled}
                           onchange={() => location.value = loc.id}/>
                    <div class="option-content">
                        <strong>{loc.name}</strong>
                        <span class="option-desc">{loc.desc}</span>
                        {disabled ? <span class="option-requires">{loc.requiresMsg}</span> : ''}
                    </div>
                </label>;
            })}
        </div>);
    </script>
</section>

<!-- Installation -->
<section class="setup-section">
    <h2>Installation</h2>

    <script type="module" is="reactive">
        const installCommands = {
            node: 'npx jsr add @bodar/dataflow',
            bun: 'bunx jsr add @bodar/dataflow',
            deno: 'deno add jsr:@bodar/dataflow',
            browser: '# No server-side installation needed for browser-only setup'
        };

        const installCode = installCommands[runtime];

        display(<div class="code-block">
            <div class="code-header">
                <span class="code-lang">bash</span>
                <button class="copy-btn" type="button" onclick={(e) => {
                    navigator.clipboard.writeText(installCode);
                    e.target.textContent = 'Copied!';
                    setTimeout(() => e.target.textContent = 'Copy', 2000);
                }}>Copy</button>
            </div>
            <pre><code class="language-bash">{installCode}</code></pre>
        </div>);
    </script>

    <script type="module" is="reactive">
        <p hidden={runtime === 'browser'}>For browsers, use an import map with the pre-minified runtime (see code example below).</p>
    </script>
</section>

<!-- Code Example -->
<section class="setup-section">
    <h2>Code Example</h2>

    <script type="module" is="reactive">
        // Code templates based on configuration
        const getCode = () => {
            // Build time with bundler (Bun only)
            if (location === 'build' && strategy === 'bundler') {
                return `import {HTMLTransformer} from '@bodar/dataflow';
import {BunBundler} from '@bodar/dataflow/bundling/BunBundler.ts';

const transformer = new HTMLTransformer({
    rewriter: new HTMLRewriter(),
    bundler: new BunBundler()
});

const output = await transformer.transform(htmlString);`;
            }

            // Build time with import map
            if (location === 'build' && strategy === 'importmap') {
                return `import {HTMLTransformer} from '@bodar/dataflow';

const importMap = {
    imports: {
        '@bodar/dataflow/runtime.ts': 'https://dataflow.bodar.com/runtime.js'
    }
};

const transformer = new HTMLTransformer({
    rewriter: new HTMLRewriter(),
    importMap
});

const output = await transformer.transform(htmlString);`;
            }

            // Build time with BYO
            if (location === 'build' && strategy === 'byo') {
                return `import {HTMLTransformer} from '@bodar/dataflow';

// No bundler or importMap - you manage modules yourself
const transformer = new HTMLTransformer({
    rewriter: new HTMLRewriter()
});

const output = await transformer.transform(htmlString);`;
            }

            // Server with bundler (Bun only)
            if (location === 'server' && strategy === 'bundler') {
                return `import {ReactiveHandler} from '@bodar/dataflow/http/ReactiveHandler.ts';
import {HTMLTransformer} from '@bodar/dataflow';
import {BunBundler} from '@bodar/dataflow/bundling/BunBundler.ts';

const transformer = () => new HTMLTransformer({
    rewriter: new HTMLRewriter(),
    bundler: new BunBundler()
});

Bun.serve({
    fetch: ReactiveHandler(transformer, async (request) => {
        // Your existing handler logic
        return new Response('<html>...</html>', {
            headers: {'content-type': 'text/html'}
        });
    })
});`;
            }

            // Server with import map
            if (location === 'server' && strategy === 'importmap') {
                const serverCode = runtime === 'bun'
                    ? `Bun.serve({
    fetch: ReactiveHandler(transformer, async (request) => {
        return new Response('<html>...</html>', {
            headers: {'content-type': 'text/html'}
        });
    })
});`
                    : `// Use with your HTTP framework
const handler = ReactiveHandler(transformer, yourRequestHandler);`;

                return `import {ReactiveHandler} from '@bodar/dataflow/http/ReactiveHandler.ts';
import {HTMLTransformer} from '@bodar/dataflow';

const importMap = {
    imports: {
        '@bodar/dataflow/runtime.ts': 'https://dataflow.bodar.com/runtime.js'
    }
};

const transformer = () => new HTMLTransformer({
    rewriter: new HTMLRewriter(),
    importMap
});

${serverCode}`;
            }

            // Server with BYO
            if (location === 'server' && strategy === 'byo') {
                return `import {ReactiveHandler} from '@bodar/dataflow/http/ReactiveHandler.ts';
import {HTMLTransformer} from '@bodar/dataflow';

// No bundler or importMap - you manage modules yourself
const transformer = () => new HTMLTransformer({
    rewriter: new HTMLRewriter()
});

// Use with your HTTP framework
const handler = ReactiveHandler(transformer, yourRequestHandler);`;
            }

            // Edge (import map or BYO only)
            if (location === 'edge') {
                if (strategy === 'importmap') {
                    return `import {ReactiveHandler} from '@bodar/dataflow/http/ReactiveHandler.ts';
import {HTMLTransformer} from '@bodar/dataflow';

const importMap = {
    imports: {
        '@bodar/dataflow/runtime.ts': 'https://dataflow.bodar.com/runtime.js'
    }
};

const transformer = () => new HTMLTransformer({
    rewriter: new HTMLRewriter(),
    importMap
});

export default {
    fetch: ReactiveHandler(transformer, fetch)
};`;
                } else {
                    return `import {ReactiveHandler} from '@bodar/dataflow/http/ReactiveHandler.ts';
import {HTMLTransformer} from '@bodar/dataflow';

// No bundler or importMap - you manage modules yourself
const transformer = () => new HTMLTransformer({
    rewriter: new HTMLRewriter()
});

export default {
    fetch: ReactiveHandler(transformer, fetch)
};`;
                }
            }

            // Browser (Service Worker)
            if (location === 'browser') {
                if (strategy === 'importmap') {
                    return `import {ReactiveHandler} from '@bodar/dataflow/http/ReactiveHandler.ts';
import {HTMLTransformer} from '@bodar/dataflow';

const importMap = {
    imports: {
        '@bodar/dataflow/runtime.ts': 'https://dataflow.bodar.com/runtime.js'
    }
};

const transformer = () => new HTMLTransformer({
    rewriter: new HTMLRewriter(),
    importMap
});

const handler = ReactiveHandler(transformer, fetch);

self.addEventListener('fetch', (event) => {
    event.respondWith(handler(event.request));
});`;
                } else {
                    return `import {ReactiveHandler} from '@bodar/dataflow/http/ReactiveHandler.ts';
import {HTMLTransformer} from '@bodar/dataflow';

// No bundler or importMap - you manage modules yourself
const transformer = () => new HTMLTransformer({
    rewriter: new HTMLRewriter(),
});

const handler = ReactiveHandler(transformer, fetch);

self.addEventListener('fetch', (event) => {
    event.respondWith(handler(event.request));
});`;
                }
            }

            return '// Select options above to see the code example';
        };

        const code = getCode();

        display(<div class="code-block">
            <div class="code-header">
                <span class="code-lang">javascript</span>
                <button class="copy-btn" type="button" onclick={(e) => {
                    navigator.clipboard.writeText(code);
                    e.target.textContent = 'Copied!';
                    setTimeout(() => e.target.textContent = 'Copy', 2000);
                }}>Copy</button>
            </div>
            <pre><code class="language-javascript">{code}</code></pre>
        </div>);
    </script>
</section>

<!-- Notes based on selection -->
<script type="module" is="reactive">
    <div class="note" hidden={strategy !== 'importmap'}>
        <strong>Islands and Import Maps:</strong> When using <a href="islands.html">reactive islands</a>, import maps are preferred. All islands share the same pre-minified runtime (~11KB gzipped) rather than each island bundling its own copy.
    </div>
</script>

<script type="module" is="reactive">
    <div class="note" hidden={location !== 'browser'}>
        <strong>Service Worker Considerations:</strong>
        <ul>
            <li>Service workers only transform pages <em>after</em> initial registration - the first page load won't be transformed unless you force a reload</li>
            <li>The service worker bundle is larger because it includes the HTML transformer and JavaScript parser (Acorn)</li>
        </ul>
    </div>
</script>

<script type="module" is="reactive">
    <div class="note" hidden={strategy !== 'byo'}>
        <strong>Bring Your Own:</strong> This option is useful if you already have an import map in your HTML, or you're doing server-side rendering with tools like HTMX where you want to manage the import map in your template. Simply don't pass <code>bundler</code> or <code>importMap</code> to the transformer.
    </div>
</script>

<script type="module" is="reactive">
    <div class="note" hidden={!(strategy === 'bundler' && runtime === 'bun')}>
        <strong>Note:</strong> <code>HTMLTransformer</code> is stateful and should be created fresh for each transformation. When using <code>ReactiveHandler</code>, pass a factory function that creates a new transformer.
    </div>
</script>

<!-- Syntax highlighting -->
<script type="module">
    import hljs from 'highlight.js/lib/core.js';
    import javascript from 'highlight.js/lib/languages/javascript';
    import bash from 'highlight.js/lib/languages/bash';

    hljs.registerLanguage('javascript', javascript);
    hljs.registerLanguage('bash', bash);

    // Re-highlight when content changes
    const observer = new MutationObserver(() => {
        document.querySelectorAll('pre code:not(.hljs)').forEach(el => {
            hljs.highlightElement(el);
        });
    });
    observer.observe(document.body, {childList: true, subtree: true});

    // Initial highlight
    hljs.highlightAll();
</script>

</body>
</html>
