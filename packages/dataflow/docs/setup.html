<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Setup - Dataflow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="setup.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/styles/intellij-light.min.css">
    <script type="importmap">
        {
            "imports": {
                "highlight.js/": "https://esm.run/highlight.js/"
            }
        }
    </script>
</head>
<body>

<div class="site-header">
    <h1>Dataflow</h1>
    <a href="https://github.com/bodar/bodar.ts/tree/master/packages/dataflow"><img alt="GitHub" src="https://img.shields.io/badge/github-repo-blue?logo=github"></a>
</div>

<nav class="docs-nav">
    <a href="index.html">Quick Start</a>
    <a href="setup.html" class="active">Setup</a>
    <a href="reactivity.html">Reactivity</a>
    <a href="inputs.html">Inputs</a>
    <a href="islands.html">Islands</a>
    <a href="examples/">Examples</a>
</nav>

<h1>Setup</h1>

<p>Dataflow transforms HTML containing <code>is="reactive"</code> scripts into interactive pages. Configure your setup by selecting your runtime and module strategy.</p>

<!-- Step 1: Runtime Selection -->
<section class="setup-section">
    <h2>1. Runtime Environment</h2>
    <p>Where will you run the transformation?</p>

    <script type="module" is="reactive">
        const runtime = mutable('bun');

        const runtimes = [
            {id: 'bun', name: 'Bun', logo: 'bun'},
            {id: 'node', name: 'Node.js', logo: 'nodedotjs'},
            {id: 'deno', name: 'Deno', logo: 'deno'},
            {id: 'cloudflare', name: 'Cloudflare', logo: 'cloudflare'},
            {id: 'browser', name: 'Browser', logo: 'googlechrome'}
        ];

        display(<div class="selector-grid">
            {runtimes.map(rt =>
                <label class="selector-card">
                    <input type="radio" name="runtime" value={rt.id}
                           onchange={() => runtime.value = rt.id}/>
                    <div class="card-content">
                        <img src={`https://cdn.simpleicons.org/${rt.logo}`} alt={rt.name} class="runtime-logo"/>
                        <span class="card-label">{rt.name}</span>
                    </div>
                </label>
            )}
        </div>);
    </script>
</section>

<!-- Step 2: Browser Transformer Selection (only shown for browser runtime) -->
<script type="module" is="reactive">
    const browserTransformer = mutable('dom');
</script>

<script type="module" is="reactive">
    <section class="setup-section" hidden={runtime !== 'browser'}>
        <h2>2. Browser Transformer</h2>
        <p>Which transformer implementation should be used?</p>

        <div class="selector-list">
            <label class="selector-option">
                <input type="radio" name="browserTransformer" value="dom" checked
                       onchange={() => browserTransformer.value = 'dom'}/>
                <div class="option-content">
                    <strong>DOMTransformer</strong>
                    <span class="option-desc">Uses the browser's native DOM parser. No external dependencies.</span>
                </div>
            </label>
            <label class="selector-option">
                <input type="radio" name="browserTransformer" value="html"
                       onchange={() => browserTransformer.value = 'html'}/>
                <div class="option-content">
                    <strong>HTMLTransformer</strong>
                    <span class="option-desc">Streaming transformer. Requires <a href="https://www.npmjs.com/package/htmlrewriter" target="_blank">htmlrewriter</a> npm package.</span>
                </div>
            </label>
        </div>
    </section>
</script>

<!-- Module Strategy Selection -->
<section class="setup-section">
    <script type="module" is="reactive">
        <h2>{runtime === 'browser' ? '3' : '2'}. Module Strategy</h2>
    </script>
    <p>How should imports be resolved?</p>

    <script type="module" is="reactive">
        const strategy = mutable('importmap');

        const strategies = [
            {id: 'importmap', name: 'Import Map', desc: 'Use pre-minified runtime via import map (~11KB gzipped)', checked: true},
            {id: 'bundler', name: 'Bundler', desc: 'Bundle and minify reactive imports with BunBundler', bunOnly: true},
            {id: 'byo', name: 'Bring Your Own', desc: 'You manage your own import map or bundling'}
        ];

        display(<div class="selector-list">
            {strategies.map(s => {
                const disabled = s.bunOnly && runtime !== 'bun';
                return <label class={`selector-option ${disabled ? 'disabled' : ''}`}>
                    <input type="radio" name="strategy" value={s.id} checked={s.checked}
                           disabled={disabled}
                           onchange={() => strategy.value = s.id}/>
                    <div class="option-content">
                        <strong>{s.name}</strong>
                        <span class="option-desc">{s.desc}</span>
                        {disabled ? <span class="option-requires">Requires Bun runtime</span> : ''}
                    </div>
                </label>;
            })}
        </div>);
    </script>
</section>

<!-- Installation -->
<section class="setup-section">
    <script type="module" is="reactive">
        <h2>{runtime === 'browser' ? '4' : '3'}. Installation</h2>
    </script>

    <script type="module" is="reactive">
        const getInstallCommand = () => {
            const commands = {
                bun: 'bunx jsr add @bodar/dataflow',
                node: 'npx jsr add @bodar/dataflow',
                deno: 'deno add jsr:@bodar/dataflow',
                cloudflare: 'npx jsr add @bodar/dataflow',
                browser: 'npx jsr add @bodar/dataflow'
            };
            let cmd = commands[runtime];
            if (runtime === 'browser' && browserTransformer === 'html') {
                cmd += '\nnpm install htmlrewriter';
            }
            return cmd;
        };

        const installCode = getInstallCommand();

        display(<div class="code-block">
            <div class="code-header">
                <span class="code-lang">bash</span>
                <button class="copy-btn" type="button" onclick={(e) => {
                    navigator.clipboard.writeText(installCode);
                    e.target.textContent = 'Copied!';
                    setTimeout(() => e.target.textContent = 'Copy', 2000);
                }}>Copy</button>
            </div>
            <pre><code class="language-bash">{installCode}</code></pre>
        </div>);
    </script>
</section>

<!-- Code Example -->
<section class="setup-section">
    <script type="module" is="reactive">
        <h2>{runtime === 'browser' ? '5' : '4'}. Code Example</h2>
    </script>

    <script type="module" is="reactive">
        const useDOMTransformer = runtime === 'browser' && browserTransformer === 'dom';

        const getCode = () => {
            const lines = [];

            // Imports
            if (useDOMTransformer) {
                lines.push(`import {DOMTransformer} from '@bodar/dataflow/html/DOMTransformer.ts';`);
            } else {
                lines.push(`import {ReactiveHandler} from '@bodar/dataflow/http/ReactiveHandler.ts';`);
                lines.push(`import {HTMLTransformer} from '@bodar/dataflow';`);
                if (runtime === 'browser') {
                    lines.push(`import {HTMLRewriter} from 'htmlrewriter';`);
                }
            }
            if (strategy === 'bundler') {
                lines.push(`import {BunBundler} from '@bodar/dataflow/bundling/BunBundler.ts';`);
            }

            // Import map config
            if (strategy === 'importmap') {
                lines.push('');
                lines.push(`const importMap = {`);
                lines.push(`    imports: {`);
                lines.push(`        '@bodar/dataflow/runtime.ts': 'https://dataflow.bodar.com/runtime.js'`);
                lines.push(`    }`);
                lines.push(`};`);
            }

            // Transformer setup
            lines.push('');
            if (useDOMTransformer) {
                const options = [];
                if (strategy === 'importmap') options.push('importMap');
                if (options.length > 0) {
                    lines.push(`const transformer = () => new DOMTransformer({${options.join(', ')}});`);
                } else {
                    lines.push(`const transformer = () => new DOMTransformer();`);
                }
            } else {
                const options = ['rewriter: new HTMLRewriter()'];
                if (strategy === 'bundler') options.push('bundler: new BunBundler()');
                if (strategy === 'importmap') options.push('importMap');

                lines.push(`const transformer = () => new HTMLTransformer({`);
                lines.push(`    ${options.join(',\n    ')}`);
                lines.push(`});`);
            }

            // Handler based on runtime
            lines.push('');
            if (runtime === 'bun') {
                lines.push(`Bun.serve({`);
                lines.push(`    fetch: ReactiveHandler(transformer, async (request) => {`);
                lines.push(`        return new Response('<html>...</html>', {`);
                lines.push(`            headers: {'content-type': 'text/html'}`);
                lines.push(`        });`);
                lines.push(`    })`);
                lines.push(`});`);
            } else if (runtime === 'cloudflare') {
                lines.push(`export default {`);
                lines.push(`    fetch: ReactiveHandler(transformer, fetch)`);
                lines.push(`};`);
            } else if (runtime === 'browser') {
                if (useDOMTransformer) {
                    lines.push(`// Example: Transform HTML string using DOMParser`);
                    lines.push(`const parser = new DOMParser();`);
                    lines.push(`const doc = parser.parseFromString(html, 'text/html');`);
                    lines.push(`await transformer().transform(doc);`);
                    lines.push(`// doc is now mutated with reactive scripts transformed`);
                    lines.push('');
                    lines.push(`// Example: Transform an iframe's document directly`);
                    lines.push(`const iframe = document.querySelector('iframe');`);
                    lines.push(`await transformer().transform(iframe.contentDocument);`);
                    lines.push(`// iframe's document is now mutated in place`);
                } else {
                    lines.push(`const handler = ReactiveHandler(transformer, fetch);`);
                    lines.push('');
                    lines.push(`self.addEventListener('fetch', (event) => {`);
                    lines.push(`    event.respondWith(handler(event.request));`);
                    lines.push(`});`);
                }
            } else {
                // Node.js, Deno
                lines.push(`const handler = ReactiveHandler(transformer, yourRequestHandler);`);
            }

            return lines.join('\n');
        };

        const code = getCode();

        display(<div class="code-block">
            <div class="code-header">
                <span class="code-lang">javascript</span>
                <button class="copy-btn" type="button" onclick={(e) => {
                    navigator.clipboard.writeText(code);
                    e.target.textContent = 'Copied!';
                    setTimeout(() => e.target.textContent = 'Copy', 2000);
                }}>Copy</button>
            </div>
            <pre><code class="language-javascript">{code}</code></pre>
        </div>);
    </script>
</section>

<!-- Notes based on selection -->
<script type="module" is="reactive">
    <div class="note" hidden={strategy !== 'importmap'}>
        <strong>Islands and Import Maps:</strong> When using <a href="islands.html">reactive islands</a>, import maps are preferred. All islands share the same pre-minified runtime (~11KB gzipped) rather than each island bundling its own copy.
    </div>
</script>

<script type="module" is="reactive">
    <div class="note" hidden={!(runtime === 'browser' && browserTransformer === 'dom')}>
        <strong>DOMTransformer:</strong>
        <ul>
            <li>Uses the browser's native <code>DOMParser</code> or can transform an iframe's document directly</li>
            <li>No external dependencies required</li>
            <li>Batch processing (parses entire document before transforming)</li>
            <li>Ideal for client-side transformation of fetched HTML or iframe content</li>
        </ul>
    </div>
</script>

<script type="module" is="reactive">
    <div class="note" hidden={!(runtime === 'browser' && browserTransformer === 'html')}>
        <strong>HTMLTransformer (Service Worker):</strong>
        <ul>
            <li>Streaming transformer - processes HTML as it flows through</li>
            <li>Requires the <a href="https://www.npmjs.com/package/htmlrewriter" target="_blank">htmlrewriter</a> npm package (a WASM port of Cloudflare's HTMLRewriter)</li>
            <li>Service workers only transform pages <em>after</em> initial registration - the first page load won't be transformed unless you force a reload</li>
            <li>Larger bundle size due to HTMLRewriter WASM and JavaScript parser (Acorn)</li>
        </ul>
    </div>
</script>

<script type="module" is="reactive">
    <div class="note" hidden={strategy !== 'byo'}>
        <strong>Bring Your Own:</strong> This option is useful if you already have an import map in your HTML, or you're doing server-side rendering with tools like HTMX where you want to manage the import map in your template. Simply don't pass <code>bundler</code> or <code>importMap</code> to the transformer.
    </div>
</script>

<script type="module" is="reactive">
    <div class="note" hidden={!(strategy === 'bundler' && runtime === 'bun')}>
        <strong>Note:</strong> <code>HTMLTransformer</code> is stateful and should be created fresh for each transformation. When using <code>ReactiveHandler</code>, pass a factory function that creates a new transformer.
    </div>
</script>

<!-- Syntax highlighting -->
<script type="module">
    import hljs from 'highlight.js/lib/core.js';
    import javascript from 'highlight.js/lib/languages/javascript';
    import bash from 'highlight.js/lib/languages/bash';

    hljs.registerLanguage('javascript', javascript);
    hljs.registerLanguage('bash', bash);

    // Re-highlight when content changes
    const observer = new MutationObserver(() => {
        document.querySelectorAll('pre code:not(.hljs)').forEach(el => {
            hljs.highlightElement(el);
        });
    });
    observer.observe(document.body, {childList: true, subtree: true});

    // Initial highlight
    hljs.highlightAll();
</script>

</body>
</html>
