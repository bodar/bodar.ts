<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Setup - Dataflow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/styles/intellij-light.min.css">
    <script type="importmap">
        {
            "imports": {
                "highlight.js/": "https://esm.run/highlight.js/"
            }
        }
    </script>
</head>
<body>

<div class="site-header">
    <h1>Dataflow</h1>
    <a href="https://github.com/bodar/bodar.ts/tree/master/packages/dataflow"><img alt="GitHub" src="https://img.shields.io/badge/github-repo-blue?logo=github"></a>
</div>

<nav class="docs-nav">
    <a href="index.html">Quick Start</a>
    <a href="setup.html" class="active">Setup</a>
    <a href="reactivity.html">Reactivity</a>
    <a href="inputs.html">Inputs</a>
    <a href="islands.html">Islands</a>
    <a href="examples/">Examples</a>
</nav>

<h1>Setup</h1>

<p>Dataflow transforms HTML containing <code>is="reactive"</code> scripts into interactive pages. The transformation can happen at build time or runtime.</p>

<h2>Installation</h2>

<div class="example">
    <pre><code class="language-bash">npx jsr add @bodar/dataflow

bunx jsr add @bodar/dataflow

deno add jsr:@bodar/dataflow

pnpm i jsr:@bodar/dataflow

yarn add jsr:@bodar/dataflow</code></pre>
</div>

<p>For browsers, use an import map with the pre-minified runtime. See <a href="#service-worker">Service Worker</a> below.</p>

<h2 id="choosing-your-approach">Choosing Your Approach</h2>

<p>Each deployment option has different trade-offs:</p>

<table>
    <thead>
    <tr>
        <th>Approach</th>
        <th>Best For</th>
        <th>Considerations</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td><a href="#build-time">Build Time</a></td>
        <td>Static sites</td>
        <td>Requires build step; can use bundler or import map</td>
    </tr>
    <tr>
        <td><a href="#bun-serve">Bun.serve</a></td>
        <td>Full-stack TypeScript apps</td>
        <td>Can use bundler or import map</td>
    </tr>
    <tr>
        <td><a href="#cloudflare-workers">Cloudflare Workers</a></td>
        <td>Any backend language, edge deployment</td>
        <td>Import map only (no bundler)</td>
    </tr>
    <tr>
        <td><a href="#service-worker">Service Worker</a></td>
        <td>No build or server available</td>
        <td>Larger runtime; doesn't transform initial page load</td>
    </tr>
    </tbody>
</table>

<div class="note">
    <strong>Islands and Bundling:</strong> When using <a href="islands.html">reactive islands</a>, prefer import maps over bundling. With a bundler, each island gets its own copy of the runtime. With an import map, all islands share the same pre-minified runtime (<script type="module" is="reactive">`${runtime.compressed} (${runtime.uncompressed} uncompressed)`</script>).
</div>

<h2 id="build-time">Build Time</h2>

<p>For static site generation or build pipelines, use <code>HTMLTransformer</code> directly:</p>

<h3>With Bundler</h3>

<p>Use <code>BunBundler</code> to bundle and minify reactive imports:</p>

<div class="example">
    <pre><code class="language-javascript">import {HTMLTransformer} from '@bodar/dataflow';
import {BunBundler} from '@bodar/dataflow/bundling/BunBundler.ts';

const transformer = new HTMLTransformer({
    rewriter: new HTMLRewriter(),
    bundler: new BunBundler()
});

const output = transformer.transform(htmlString);</code></pre>
</div>

<h3>With Import Map</h3>

<p>For pages using <a href="islands.html">reactive islands</a>, use an import map to share the runtime across islands:</p>

<div class="example">
    <pre><code class="language-javascript">import {HTMLTransformer} from '@bodar/dataflow';

const importMap = {
    imports: {
        '@bodar/dataflow/runtime.ts': 'https://dataflow.bodar.com/runtime.js'
    }
};

const transformer = new HTMLTransformer({
    rewriter: new HTMLRewriter(),
    importMap
});

const output = transformer.transform(htmlString);</code></pre>
</div>

<div class="note">
    <strong>Note:</strong> <code>HTMLTransformer</code> is stateful and should be created fresh for each transformation.
</div>

<h2>Runtime with ReactiveHandler</h2>

<p>For fetch-compatible systems, use <code>ReactiveHandler</code> middleware to automatically transform HTML responses. It handles the plumbing of checking content-type and status, and creates a fresh transformer per request.</p>

<h3 id="bun-serve">Bun.serve</h3>

<p>With Bun, you can use <code>BunBundler</code> to bundle and minify imports at runtime:</p>

<div class="example">
    <pre><code class="language-javascript">import {ReactiveHandler} from '@bodar/dataflow/http/ReactiveHandler.ts';
import {HTMLTransformer} from '@bodar/dataflow';
import {BunBundler} from '@bodar/dataflow/bundling/BunBundler.ts';

const transformer = () => new HTMLTransformer({
    rewriter: new HTMLRewriter(),
    bundler: new BunBundler()
});

Bun.serve({
    fetch: ReactiveHandler(transformer, async (request) => {
        // Your existing handler logic
        return new Response('&lt;html&gt;...&lt;/html&gt;', {
            headers: {'content-type': 'text/html'}
        });
    })
});</code></pre>
</div>

<p>For pages using <a href="islands.html">reactive islands</a>, use an import map instead to share the runtime:</p>

<div class="example">
    <pre><code class="language-javascript">import {ReactiveHandler} from '@bodar/dataflow/http/ReactiveHandler.ts';
import {HTMLTransformer} from '@bodar/dataflow';

const importMap = {
    imports: {
        '@bodar/dataflow/runtime.ts': 'https://dataflow.bodar.com/runtime.js'
    }
};

const transformer = () => new HTMLTransformer({
    rewriter: new HTMLRewriter(),
    importMap
});

Bun.serve({
    fetch: ReactiveHandler(transformer, async (request) => {
        return new Response('&lt;html&gt;...&lt;/html&gt;', {
            headers: {'content-type': 'text/html'}
        });
    })
});</code></pre>
</div>

<h3 id="cloudflare-workers">Cloudflare Workers</h3>

<p>Cloudflare Workers run at the edge and work with any backend - your HTML can come from any language or framework. Use an import map pointing to the pre-minified runtime:</p>

<div class="example">
    <pre><code class="language-javascript">import {ReactiveHandler} from '@bodar/dataflow/http/ReactiveHandler.ts';
import {HTMLTransformer} from '@bodar/dataflow';

const importMap = {
    imports: {
        '@bodar/dataflow/runtime.ts': 'https://dataflow.bodar.com/runtime.js'
    }
};

const transformer = () => new HTMLTransformer({
    rewriter: new HTMLRewriter(),
    importMap
});

export default {
    fetch: ReactiveHandler(transformer, fetch)
};</code></pre>
</div>

<h3 id="service-worker">Service Worker</h3>

<p>Transform HTML client-side for progressive enhancement and offline-first applications:</p>

<div class="example">
    <pre><code class="language-javascript">import {ReactiveHandler} from '@bodar/dataflow/http/ReactiveHandler.ts';
import {HTMLTransformer} from '@bodar/dataflow';

const importMap = {
    imports: {
        '@bodar/dataflow/runtime.ts': 'https://dataflow.bodar.com/runtime.js'
    }
};

const transformer = () => new HTMLTransformer({
    rewriter: new HTMLRewriter(),
    importMap
});

const handler = ReactiveHandler(transformer, fetch);

self.addEventListener('fetch', (event) => {
    event.respondWith(handler(event.request));
});</code></pre>
</div>

<div class="note">
    <strong>Considerations:</strong>
    <ul>
        <li>Service workers only transform pages <em>after</em> initial registration - the first page load won't be transformed unless you force a reload</li>
        <li>The service worker bundle is larger because it includes the HTML transformer and JavaScript parser (Acorn)</li>
        <li>Point the import map to your own bundled runtime rather than the CDN if you're already bundling the transformer</li>
    </ul>
</div>

<script type="module" is="reactive">
    const runtime = fetch('https://dataflow.bodar.com/runtime.js')
        .then(async r => {
            const compressed = r.headers.get('content-length');
            const uncompressed = (await r.text()).length;
            return {
                compressed: `${Math.round(compressed / 1024)}KB`,
                uncompressed: `${Math.round(uncompressed / 1024)}KB`
            };
        });
</script>

<script type="module">
    import hljs from 'highlight.js/lib/core.js';
    import javascript from 'highlight.js/lib/languages/javascript';
    import bash from 'highlight.js/lib/languages/bash';
    import xml from 'highlight.js/lib/languages/xml';

    hljs.registerLanguage('javascript', javascript);
    hljs.registerLanguage('bash', bash);
    hljs.registerLanguage('xml', xml);
    hljs.highlightAll();
</script>

</body>
</html>
